<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Чат</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body { font-family: Arial; margin:20px; }
.msg { margin:5px 0; }
.me { text-align:right; color:blue; }
.other { text-align:left; color:green; }
#typing { color: gray; height: 20px; }
img.chat-img { max-width:200px; border-radius:10px; margin:5px 0; cursor:pointer; }

/* Lightbox */
#lightbox {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.8);
  display:none; justify-content:center; align-items:center;
  z-index:1000;
}
#lightbox img { max-width:90%; max-height:90%; border-radius:10px; }
</style>
</head>
<body>

<a href="{{ url_for('users') }}">Назад</a>
<h3>Чат с {{ other }}</h3>

<div id="chat">
    {% for m in chat_messages %}
        {% if m.type == "text" %}
        <div class="msg {% if m.sender==me %}me{% else %}other{% endif %}">
            <b>{{ m.sender }}:</b> {{ m.text }}
        </div>
        {% else %}
        <div class="msg {% if m.sender==me %}me{% else %}other{% endif %}">
            <b>{{ m.sender }}:</b><br>
            <img class="chat-img" src="{{ m.url }}">
        </div>
        {% endif %}
    {% endfor %}
</div>

<div id="typing"></div>

<form id="msgForm">
    <input id="msgInput" type="text" placeholder="Сообщение..." autocomplete="off">
    <button type="submit">Отправить</button>
</form>

<form id="imgForm" enctype="multipart/form-data">
    <input type="file" id="imgFile" accept="image/*">
    <button type="submit">Фото</button>
</form>

<!-- Lightbox -->
<div id="lightbox"><img id="lightbox-img"></div>

<script>
const me="{{ me }}";
const other="{{ other }}";
const room=[me,other].sort().join("_");
const socket=io();
socket.emit("join",{room:room});

const chat=document.getElementById("chat");
const typingEl=document.getElementById("typing");

// Lightbox
const lightbox=document.getElementById("lightbox");
const lbImg=document.getElementById("lightbox-img");
chat.addEventListener("click", e=>{
    if(e.target.tagName==="IMG"){
        lbImg.src=e.target.src;
        lightbox.style.display="flex";
    }
});
lightbox.addEventListener("click", ()=>lightbox.style.display="none");

socket.on("new_message", msg=>{
    let html="";
    if(msg.type==="text"){
        html=`<div class="msg ${msg.sender===me?'me':'other'}"><b>${msg.sender}:</b> ${msg.text}</div>`;
    } else {
        html=`<div class="msg ${msg.sender===me?'me':'other'}"><b>${msg.sender}:</b><br>
        <img class="chat-img" src="${msg.url}"></div>`;
    }
    chat.innerHTML+=html;
});

// typing
let typing=false;
let timer;
document.getElementById("msgInput").addEventListener("input", ()=>{
    if(!typing){ typing=true; socket.emit("typing",{room:room,user:me,status:"typing"}); }
    clearTimeout(timer);
    timer=setTimeout(()=>{ typing=false; socket.emit("typing",{room:room,user:me,status:"stop"}); },1000);
});
socket.on("typing_status", data=>{
    if(data.status==="typing") typingEl.innerText=`${data.user} печатает...`;
    else typingEl.innerText="";
});

// отправка текста
document.getElementById("msgForm").onsubmit=e=>{
    e.preventDefault();
    const text=document.getElementById("msgInput").value.trim();
    if(!text) return;
    socket.emit("message",{sender:me,receiver:other,text:text});
    document.getElementById("msgInput").value="";
    typing=false;
    socket.emit("typing",{room:room,user:me,status:"stop"});
};

// отправка фото
document.getElementById("imgForm").onsubmit=async e=>{
    e.preventDefault();
    let fileInput=document.getElementById("imgFile");
    if(fileInput.files.length===0) return;
    let fd=new FormData();
    fd.append("file", fileInput.files[0]);
    fd.append("other", other);
    await fetch("/upload_image",{method:"POST",body:fd});
    fileInput.value="";
};
</script>

</body>
</html>
