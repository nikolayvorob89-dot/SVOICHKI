<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Чат</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="sidebar">
    <h3>{{ username }}</h3>
    <p>Чат с {{ chat_with }}</p>
    <a href="/users">Назад</a>
</div>

<div class="chat-window" id="chat"></div>

<div id="typing" style="padding: 10px; font-size: 14px; color: gray;"></div>

<form id="form" class="message-input">
    <input type="text" id="msg" placeholder="Написать..." autocomplete="off">
    <button type="submit">Отправить</button>
</form>

<script>
    const socket = io();
    const username = "{{ username }}";
    const chatWith = "{{ chat_with }}";

    const room = "room_" + [username, chatWith].sort().join("_");

    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const typing = document.getElementById("typing");

    // Join room
    socket.emit("join", { room });

    // Load history
    function loadHistory() {
        fetch("/messages/" + chatWith)
            .then(r => r.json())
            .then(data => {
                chat.innerHTML = "";
                data.forEach(m => {
                    const div = document.createElement("div");
                    div.className = m.startsWith(username) ? "message self" : "message other";
                    div.innerText = m;
                    chat.appendChild(div);
                });
                chat.scrollTop = chat.scrollHeight;
            });
    }
    loadHistory();

    // Send message
    document.getElementById("form").addEventListener("submit", e => {
        e.preventDefault();
        if (!input.value.trim()) return;

        socket.emit("send_message", {
            sender: username,
            receiver: chatWith,
            message: input.value
        });

        input.value = "";
    });

    // Receive new messages
    socket.on("new_message", data => {
        const div = document.createElement("div");
        div.className = data.startsWith(username) ? "message self" : "message other";
        div.innerText = data;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });

    // Typing event
    let typingTimeout;
    input.addEventListener("input", () => {
        socket.emit("typing", { sender: username, receiver: chatWith });

        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typing.innerText = "";
        }, 1000);
    });

    socket.on("typing_status", text => {
        typing.innerText = text;
        setTimeout(() => typing.innerText = "", 1500);
    });
</script>

</body>
</html>
