<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Чат</title>

    <!-- ВАЖНО: socket.io 3.1.3 — единственный полностью совместимый -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@3.1.3/dist/socket.io.min.js"></script>
</head>
<body>

<h2>Чат с {{ receiver }}</h2>

<div id="messages" style="height:300px; width:400px; border:1px solid #ccc; overflow-y:auto; padding:5px;">
    {% for sender, text in messages %}
        <p><b>{{ sender }}:</b> {{ text }}</p>
    {% endfor %}
</div>

<p id="typing_status" style="color: gray;"></p>

<form id="message_form">
    <input type="text" id="message_input" style="width:300px;">
    <button type="submit">Отправить</button>
</form>

<script>
    const socket = io();

    const username = "{{ username }}";
    const receiver = "{{ receiver }}";

    socket.emit("join", {sender: username, receiver: receiver});


    socket.on("new_message", data => {
        const box = document.getElementById("messages");
        box.innerHTML += `<p><b>${data.sender}:</b> ${data.text}</p>`;
        box.scrollTop = box.scrollHeight;
    });


    // typing
    let typing = false;
    let timer;

    function sendTyping() {
        if (!typing) {
            typing = true;
            socket.emit("typing", {sender: username, receiver: receiver});
        }

        clearTimeout(timer);
        timer = setTimeout(() => {
            typing = false;
            socket.emit("stop_typing", {sender: username, receiver: receiver});
        }, 1000);
    }

    document.getElementById("message_input").addEventListener("input", sendTyping);


    document.getElementById("message_form").onsubmit = e => {
        e.preventDefault();
        const text = document.getElementById("message_input").value.trim();
        if (!text) return;

        socket.emit("send_message", {
            sender: username,
            receiver: receiver,
            text: text
        });

        socket.emit("stop_typing", {sender: username, receiver: receiver});
        typing = false;

        document.getElementById("message_input").value = "";
    };


    socket.on("show_typing", data => {
        if (data.sender !== receiver) return;
        document.getElementById("typing_status").innerText = receiver + " печатает...";
    });

    socket.on("hide_typing", data => {
        if (data.sender !== receiver) return;
        document.getElementById("typing_status").innerText = "";
    });

</script>
</body>
</html>
