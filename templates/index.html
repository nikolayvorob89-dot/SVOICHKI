<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä SVOICHKI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="col-3 p-0 bg-light chat-list">
            {% for user in users %}
            <div class="chat-item" onclick="selectUser('{{user}}')">{{user}}</div>
            {% endfor %}
            <div class="chat-item"><a href="/logout">–í—ã–π—Ç–∏</a></div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div class="col-9 chat-window">
            <!-- –ë–ª–æ–∫ —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
            <div id="current-user" class="p-2 bg-secondary text-white">
                –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: {{username}}
            </div>

            <div id="messages"></div>
            <div id="typing-status"></div>
            <div class="p-3 border-top d-flex">
                <input type="text" class="form-control me-2" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <input type="file" id="file-input" style="display:none;" accept="image/*">
                <button class="btn btn-secondary me-2" id="attach-btn">üìé</button>
                <button class="btn btn-primary" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
const socket = io();
let currentReceiver = null;
let typingTimeout;
const username = "{{username}}";

function selectUser(user){
    currentReceiver = user;
    document.getElementById('messages').innerHTML = '';
    document.getElementById('typing-status').textContent = '';

    socket.emit('join', {receiver: user});

    fetch(`/messages/${user}`)
    .then(res => res.json())
    .then(data => {
        const messagesDiv = document.getElementById('messages');
        data.forEach(msg => {
            const div = document.createElement('div');
            div.className = msg.sender === username ? 'message user' : 'message other';
            if(msg.message.startsWith('/static/uploads/')){
                const img = document.createElement('img');
                img.src = msg.message.replace(/\\/g,'/');
                img.className = 'chat-image';
                img.addEventListener('click',()=>showImageModal(img.src));
                div.appendChild(img);
            } else {
                div.textContent = msg.sender + ": " + msg.message;
            }
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}

function sendMessage(){
    const input = document.getElementById('message-input');
    if(input.value.trim() !== '' && currentReceiver){
        socket.emit('send_message', {message: input.value, receiver: currentReceiver});
        input.value = '';
        document.getElementById('typing-status').textContent = '';
    }
}

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('message-input').addEventListener('keypress', (e)=>{
    if(e.key==='Enter'){ sendMessage(); e.preventDefault(); }
    if(currentReceiver){
        socket.emit('typing', {receiver: currentReceiver});
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(()=>{document.getElementById('typing-status').textContent='';},1000);
    }
});

const attachBtn = document.getElementById('attach-btn');
const fileInput = document.getElementById('file-input');
attachBtn.addEventListener('click',()=>fileInput.click());

fileInput.addEventListener('change', ()=>{
    if(fileInput.files.length===0 || !currentReceiver) return;
    socket.emit('join', {receiver: currentReceiver});

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('receiver', currentReceiver);

    fetch('/upload',{method:'POST',body:formData})
    .then(res=>{
        if(res.ok) fileInput.value='';
    });
});

socket.on('receive_message', data=>{
    if(data.sender!==currentReceiver && data.sender!==username) return;
    const div = document.createElement('div');
    div.className = data.sender === username ? 'message user' : 'message other';
    if(data.message.startsWith('/static/uploads/')){
        const img = document.createElement('img');
        img.src = data.message.replace(/\\/g,'/');
        img.className = 'chat-image';
        img.addEventListener('click',()=>showImageModal(img.src));
        div.appendChild(img);
    } else {
        div.textContent = data.sender + ": " + data.message;
    }
    const messagesDiv = document.getElementById('messages');
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

socket.on('display_typing', data=>{
    if(data.sender===currentReceiver){
        const status = document.getElementById('typing-status');
        status.textContent = data.sender + " –ø–µ—á–∞—Ç–∞–µ—Ç...";
        clearTimeout(typingTimeout);
        typingTimeout=setTimeout(()=>{status.textContent='';},1000);
    }
});

function showImageModal(src){
    let modal=document.getElementById('image-modal');
    if(!modal){
        modal=document.createElement('div');
        modal.id='image-modal';
        modal.style.position='fixed';
        modal.style.top='0';
        modal.style.left='0';
        modal.style.width='100vw';
        modal.style.height='100vh';
        modal.style.background='rgba(0,0,0,0.8)';
        modal.style.display='flex';
        modal.style.justifyContent='center';
        modal.style.alignItems='center';
        modal.style.zIndex='1000';
        modal.addEventListener('click',()=>modal.remove());
        const img=document.createElement('img');
        img.id='modal-img';
        img.style.maxWidth='90%';
        img.style.maxHeight='90%';
        img.style.borderRadius='10px';
        modal.appendChild(img);
        document.body.appendChild(modal);
    }
    document.getElementById('modal-img').src=src;
    modal.style.display='flex';
}
</script>
</body>
</html>
